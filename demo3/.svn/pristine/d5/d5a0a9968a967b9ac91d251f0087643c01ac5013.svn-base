#include "mapper.h"

void handle_input(Client* client, char* line, FILE* stream);
void add_map(Client* client, char* line);
void get_map(Map* dict, char* line, FILE* stream);
void list_map(Map* dict, FILE* stream);
bool valid_input(char* line);
bool valid_port(char* key);
bool in_map(Map* dict, char* key);
void sort_map(Map* dict);

int main(int argc, char** argv) {
    Client* client = malloc(sizeof(Client));
    client->dict = malloc(sizeof(Map));
    client->dict->map = malloc(sizeof(Pair));
    client->dict->numMap = 0;
    client->handle_input = handle_input;

    int error = start_server(client);

    for (int i = 0; i < client->dict->numMap; ++i) {
        free(&client->dict->map[i]);
    }

    free(client->dict->map);
    free(client->dict);
    free(client);

    return error;
}

void handle_input(Client* client, char* line, FILE* stream) {
    line[strlen(line) - 1] = '\0';
    if (line[0] == '@') {
        //printf("ALL\n");
        list_map(client->dict, stream);
    } else if (line[0] == '!') {
        line = &line[1];
        //printf("ADD\n");
        add_map(client, line);
    } else if (line[0] == '?') {
        //printf("GET\n");
        line = &line[1];
        get_map(client->dict, line, stream);
    }
}

void add_map(Client* client, char* line) {
    char* key;
    char* val;
    Map* dict = client->dict;

    if (strlen(line) < 3 || strstr(line, ":") == NULL) {
        return;
    }

    key = strtok(line, ":");
    val = strtok(NULL, ":");

    if (!valid_input(key) || !valid_input(val)
        || in_map(dict, key) || !valid_port(val)) {
        return;
    }

    Pair* pair = malloc(sizeof(Pair));
    pair->key = calloc(strlen(key) + 1, sizeof(char));
    strcpy(pair->key, key);

    pair->val = calloc(strlen(val) + 1, sizeof(char));
    strcpy(pair->val, val);

    dict->map = realloc(dict->map, sizeof(Pair) * (dict->numMap + 1));
    sem_wait(client->guard);
    dict->map[dict->numMap] = *pair;
    sem_post(client->guard);
    dict->numMap += 1;

    sort_map(dict);
}

void get_map(Map* dict, char* line, FILE* stream) {
    char buff[BUFF_SIZE];
    for (int i = 0; i < dict->numMap; ++i) {
        if (strcmp(dict->map[i].key, line) == 0) {
            sprintf(buff, "%s\n", dict->map[i].val);
            fputs(buff, stream);
            fflush(stream);
            return;
        }
    }
    sprintf(buff, ";\n");
    fputs(buff, stream);
    fflush(stream);
}

void list_map(Map* dict, FILE* stream) {
    char buff[BUFF_SIZE];
    for (int i = 0; i < dict->numMap; ++i) {
        sprintf(buff, "%s:%s\n", dict->map[i].key, dict->map[i].val);
        fputs(buff, stream);
        fflush(stream);
    }
    fflush(stream);
}



bool in_map(Map* dict, char* key) {
    for (int i = 0; i < dict->numMap; ++i) {
        if (strcmp(dict->map[i].key, key) == 0) {
            return true;
        }
    }
    return false;
}

bool valid_port(char* key) {
    for (int i = 0; i < strlen(key); ++i) {
        if (!isdigit(key[i])) {
            return false;
        }
    }
    return true;
}

void sort_map(Map* dict) {
    for (int i = 0; i < dict->numMap; ++i) {
        for (int j = i + 1; j < dict->numMap; ++j) {
            Pair* first = &dict->map[i];
            Pair* second = &dict->map[j];
            Pair temp;
            if (strcmp(first->key, second->key) > 0) {
                temp = *first;
                dict->map[i] = *second;
                dict->map[j] = temp;
            }
        }
    }
}