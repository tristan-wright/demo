#include "roc.h"

int visit(Roc* roc);
int comm(unsigned int port);
int contact(Roc* roc, int sock, int (*type)(Roc*, FILE*, FILE*, char*, char*), char*);
int get_port(Roc* roc, int sock);
int check_error(bool err);
int airport(Roc* roc, FILE* out, FILE* in, char*, char*);
int mapper(Roc* roc, FILE* out, FILE* in, char*, char*);

int main(int argc, char** argv) {
    Roc* roc = malloc(sizeof(Roc));

    if (argc < 3) {
        fprintf(stderr, "Usage: roc2310 id mapper {airports}\n");
        return 1;
    }

    roc->id = calloc(strlen(argv[1]), sizeof(char));
    roc->id = argv[1];

    if(strcmp(argv[2], "-") != 0) {
        int mapper = atoi(argv[2]);
        if (!valid_port(mapper)) {
            fprintf(stderr, "Invalid mapper port\n");
            return 2;
        } else {
            roc->port = mapper; // htons
        }
    }

    roc->numAirports = argc - 3;
    roc->airports = calloc(argc-3, sizeof(char*));
    for (int i = 3; i < argc; ++i) {
        roc->airports[i - 3] = malloc(strlen(argv[i]));
        strcpy(roc->airports[i - 3], argv[i]);
    }
    return visit(roc);
}

int visit(Roc* roc) {
    bool err = false;
    for (int i = 0; i < roc->numAirports; ++i) {
        int port = atoi(roc->airports[i]);
        int sock = comm(port);
        if (valid_port(port)) {
            if (sock > 0) {
                contact(roc, sock, airport, "");
                close(sock);
            } else {
                err = true;
            }
            continue;
        } else if (roc->port == 0){
            fprintf(stderr, "Mapper required\n");
            return 3;
        } else {
            int mapSock = comm(roc->port);
            if (mapSock < 0) {
                fprintf(stderr, "Failed to connect to mapper\n");
                return 4;
            }

            int newPort = contact(roc, mapSock, mapper, roc->airports[i]);
            if (newPort < 0) {
                fprintf(stderr, "No map entry for destination\n");
                return 5;
            } else if (valid_port(newPort)) {
                int ctrlSock = comm(newPort);
                contact(roc, ctrlSock, airport, "");
                close(ctrlSock);
                close(mapSock);
                continue;
            }
            close(sock);
        }
        err = true;
    }
    return check_error(err);
}

int airport(Roc* roc, FILE* out, FILE* in, char* buffer, char* line) {
    fprintf(out, "%s\n", roc->id);
    fflush(out);

    fgets(buffer, BUFF_SIZE, in);
    fprintf(stdout, "%s", buffer);
    return 0;
}

int mapper(Roc* roc, FILE* out, FILE* in, char* buffer, char* line) {
    fprintf(out, "?%s\n", line);
    fflush(out);

    fgets(buffer, BUFF_SIZE, in);

    if (strcmp(buffer, ";\n") == 0) {
        return -1;
    }
    int val = atoi(buffer);
    return val;
}

int contact(Roc* roc, int sock, int (*type)(Roc*, FILE*, FILE*, char*, char*), char* line) {
    FILE* out = fdopen(sock, "w");
    FILE* in = fdopen(sock, "r");
    char buffer[BUFF_SIZE];

    int retVal = type(roc, out, in, buffer, line);

    fclose(in);
    fclose(out);
    return retVal;
}


int comm(unsigned int port) {
    int sock;
    struct sockaddr_in sai;

    sock = socket(AF_INET, SOCK_STREAM, 0);

    if (sock < 0) {
        return -1;
    }
    memset(&sai, 0, sizeof(struct sockaddr_in));
    sai.sin_family = AF_INET;
    sai.sin_port = htons(port);
    sai.sin_addr.s_addr = inet_addr("127.0.0.1");

    if (connect(sock, (struct sockaddr*) &sai, sizeof(sai)) < 0) {
        return -1;
    }

    return sock;
}

int check_error(bool err) {
    if (err) {
        fprintf(stderr, "Failed to connect to at least one destination\n");
        return 6;
    }
    return 0;
}